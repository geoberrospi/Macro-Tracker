<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Fitness Tracker</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Light gray background */
        }
        .loading-animation {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .card {
            border: 1px solid #e2e8f0;
            background-color: #ffffff;
        }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root" class="min-h-screen flex">
        <!-- The app content will be rendered here -->
    </div>

    <script type="module">
        // Import necessary Firebase libraries
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Your Firebase project configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDLdU8lH81GfJ-ECXNn9be-RSVM4Qb7TNA",
            authDomain: "fitness-tracker-4a53d.firebaseapp.com",
            projectId: "fitness-tracker-4a53d",
            storageBucket: "fitness-tracker-4a53d.firebasestorage.app",
            messagingSenderId: "368173630360",
            appId: "1:368173630360:web:da7c2f8fa3ce1c4a8921ed",
            measurementId: "G-MG371PXKL4"
        };
        
        const appId = firebaseConfig.projectId;

        // Global state variables
        let user = null;
        let isAuthReady = false;
        let view = 'dashboard';
        let macroGoals = { protein: 137, carbs: 307, fat: 106 };
        let dailyMacros = { protein: 0, carbs: 0, fat: 0 };
        let meals = [];
        let weightLog = [];
        let measurementsLog = [];
        let message = '';
        const root = document.getElementById('root');

        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Utility Functions ---
        function showMessage(msg, type = 'info') {
            message = msg;
            renderApp(); // Re-render to show the message
            setTimeout(() => {
                message = '';
                renderApp(); // Re-render to hide the message
            }, 3000);
        }

        function calculateCountdown(targetDate) {
            const now = new Date();
            const target = new Date(targetDate);
            const diff = target - now;
            if (diff <= 0) return { days: 0, hours: 0, minutes: 0, seconds: 0 };
            const seconds = Math.floor((diff / 1000) % 60);
            const minutes = Math.floor((diff / 1000 / 60) % 60);
            const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            return { days, hours, minutes, seconds };
        }

        // --- Event Handlers ---
        async function handleUpdateMacroGoals(e) {
            e.preventDefault();
            const form = e.target;
            const newProtein = Number(form.protein.value);
            const newCarbs = Number(form.carbs.value);
            const newFat = Number(form.fat.value);

            if (!user) {
                showMessage('Please wait for authentication to complete.');
                return;
            }
            const userId = auth.currentUser.uid;
            const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}`);
            try {
                await setDoc(userDocRef, { macroGoals: { protein: newProtein, carbs: newCarbs, fat: newFat } }, { merge: true });
                showMessage('Macro goals updated successfully!');
            } catch (e) {
                console.error("Error updating macro goals: ", e);
                showMessage('Failed to update macro goals.');
            }
        }
        
        async function handleAddMeal(e) {
            e.preventDefault();
            const form = e.target;
            const name = form.mealName.value;
            const protein = Number(form.protein.value);
            const carbs = Number(form.carbs.value);
            const fat = Number(form.fat.value);

            if (!name || !protein || !carbs || !fat) {
                showMessage('Please fill out all meal fields.');
                return;
            }
            if (!user) {
                showMessage('Please wait for authentication to complete.');
                return;
            }
            const userId = auth.currentUser.uid;
            const mealsColRef = collection(db, `/artifacts/${appId}/users/${userId}/meals`);
            try {
                await addDoc(mealsColRef, { name, protein, carbs, fat, timestamp: serverTimestamp() });
                form.reset();
                showMessage('Meal added successfully!');
            } catch (e) {
                console.error("Error adding meal:", e);
                showMessage('Failed to add meal.');
            }
        }

        async function handleAddWeight(e) {
            e.preventDefault();
            const weightInput = e.target.weight;
            const weight = Number(weightInput.value);
            if (!weight) {
                showMessage('Please enter a weight.');
                return;
            }
            if (!user) {
                showMessage('Please wait for authentication to complete.');
                return;
            }
            const userId = auth.currentUser.uid;
            const weightsColRef = collection(db, `/artifacts/${appId}/users/${userId}/weights`);
            try {
                await addDoc(weightsColRef, { weight, date: new Date().toISOString().split('T')[0], timestamp: serverTimestamp() });
                weightInput.value = '';
                showMessage('Weight added successfully!');
            } catch (e) {
                console.error("Error adding weight:", e);
                showMessage('Failed to add weight.');
            }
        }

        async function handleAddMeasurements(e) {
            e.preventDefault();
            const form = e.target;
            const chest = Number(form.chest.value);
            const waist = Number(form.waist.value);
            const thigh = Number(form.thigh.value);
            if (!chest || !waist || !thigh) {
                showMessage('Please enter all measurements.');
                return;
            }
            if (!user) {
                showMessage('Please wait for authentication to complete.');
                return;
            }
            const userId = auth.currentUser.uid;
            const measurementsColRef = collection(db, `/artifacts/${appId}/users/${userId}/measurements`);
            try {
                await addDoc(measurementsColRef, { chest, waist, thigh, date: new Date().toISOString().split('T')[0], timestamp: serverTimestamp() });
                form.reset();
                showMessage('Measurements added successfully!');
            } catch (e) {
                console.error("Error adding measurements:", e);
                showMessage('Failed to add measurements.');
            }
        }

        // --- Renderer Functions ---
        function createCountdownElement(targetDate, title, id) {
            const container = document.createElement('div');
            container.className = "flex flex-col items-center p-4 rounded-lg shadow-md w-full card";
            container.innerHTML = `
                <h3 class="text-xl font-bold mb-2 text-indigo-600">${title}</h3>
                <div class="flex justify-center space-x-4 text-gray-800" id="${id}">
                    <!-- Countdown numbers will be injected here -->
                </div>
            `;
            
            const updateCountdown = () => {
                const time = calculateCountdown(targetDate);
                const countdownEl = container.querySelector(`#${id}`);
                if (countdownEl) {
                     countdownEl.innerHTML = `
                        <div class="flex flex-col items-center">
                            <span class="text-4xl font-bold">${time.days}</span>
                            <span class="text-sm text-gray-500">Days</span>
                        </div>
                        <div class="flex flex-col items-center">
                            <span class="text-4xl font-bold">${time.hours}</span>
                            <span class="text-sm text-gray-500">Hours</span>
                        </div>
                        <div class="flex flex-col items-center">
                            <span class="text-4xl font-bold">${time.minutes}</span>
                            <span class="text-sm text-gray-500">Minutes</span>
                        </div>
                        <div class="flex flex-col items-center">
                            <span class="text-4xl font-bold">${time.seconds}</span>
                            <span class="text-sm text-gray-500">Seconds</span>
                        </div>
                    `;
                }
            };

            updateCountdown();
            setInterval(updateCountdown, 1000);
            return container;
        }

        function renderDashboard() {
            const content = document.createElement('div');
            content.className = "space-y-6 max-w-2xl mx-auto";
            content.appendChild(createCountdownElement("2025-12-29T00:00:00", "Time until Wedding", "countdown-wedding"));
            const quote = document.createElement('div');
            quote.className = "rounded-xl shadow-md p-6 text-center card";
            quote.innerHTML = `<p class="text-xl font-semibold italic text-indigo-600">"You can do it. Every small step forward is a victory."</p>`;
            content.appendChild(quote);
            content.appendChild(createCountdownElement("2025-10-31T00:00:00", "Time until Josh's Wedding", "countdown-josh-wedding"));
            return content;
        }

        function renderMacros() {
            const content = document.createElement('div');
            content.className = "space-y-6 text-gray-800 max-w-2xl mx-auto";
            
            const messageEl = message ? `<div class="p-3 bg-blue-100 text-blue-800 rounded-lg text-sm text-center card">${message}</div>` : '';
            
            content.innerHTML = `
                <h2 class="text-2xl font-bold text-center text-indigo-600">Macro Tracker</h2>
                ${messageEl}
                <div class="rounded-xl shadow-md p-4 card">
                    <h3 class="text-lg font-semibold mb-2">My Daily Macro Goals</h3>
                    <form id="macroGoalsForm" class="flex flex-col space-y-2">
                        <div class="grid grid-cols-3 gap-2">
                            <div>
                                <label class="text-xs text-gray-500">Protein (g)</label>
                                <input name="protein" type="number" value="${macroGoals.protein}" class="w-full border border-gray-300 rounded-md p-2 bg-slate-100 text-gray-800" />
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Carbs (g)</label>
                                <input name="carbs" type="number" value="${macroGoals.carbs}" class="w-full border border-gray-300 rounded-md p-2 bg-slate-100 text-gray-800" />
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Fat (g)</label>
                                <input name="fat" type="number" value="${macroGoals.fat}" class="w-full border border-gray-300 rounded-md p-2 bg-slate-100 text-gray-800" />
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white rounded-md py-2 hover:bg-indigo-700 transition duration-300">Update Goals</button>
                    </form>
                </div>
                <div class="rounded-xl shadow-md p-4 card">
                    <h3 class="text-lg font-semibold mb-2">Today's Progress</h3>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div>
                            <span class="text-2xl font-bold">${dailyMacros.protein}g</span> / <span class="text-gray-500">${macroGoals.protein}g</span>
                            <p class="text-sm text-gray-500">Protein</p>
                        </div>
                        <div>
                            <span class="text-2xl font-bold">${dailyMacros.carbs}g</span> / <span class="text-gray-500">${macroGoals.carbs}g</span>
                            <p class="text-sm text-gray-500">Carbs</p>
                        </div>
                        <div>
                            <span class="text-2xl font-bold">${dailyMacros.fat}g</span> / <span class="text-gray-500">${macroGoals.fat}g</span>
                            <p class="text-sm text-gray-500">Fat</p>
                        </div>
                    </div>
                </div>
                <div class="rounded-xl shadow-md p-4 card">
                    <h3 class="text-lg font-semibold mb-2">Add a Meal</h3>
                    <form id="addMealForm" class="flex flex-col space-y-2">
                        <input name="mealName" type="text" placeholder="Meal Name (e.g., Chicken Salad)" class="w-full border border-gray-300 rounded-md p-2 bg-slate-100 text-gray-800" />
                        <div class="grid grid-cols-3 gap-2">
                            <input name="protein" type="number" placeholder="Protein (g)" class="w-full border border-gray-300 rounded-md p-2 bg-slate-100 text-gray-800" />
                            <input name="carbs" type="number" placeholder="Carbs (g)" class="w-full border border-gray-300 rounded-md p-2 bg-slate-100 text-gray-800" />
                            <input name="fat" type="number" placeholder="Fat (g)" class="w-full border border-gray-300 rounded-md p-2 bg-slate-100 text-gray-800" />
                        </div>
                        <button type="submit" class="w-full bg-green-600 text-white rounded-md py-2 hover:bg-green-700 transition duration-300">Log Meal</button>
                    </form>
                    <div class="mt-4">
                        <h4 class="font-semibold">Logged Meals:</h4>
                        <ul id="mealsList" class="text-sm mt-2 space-y-1"></ul>
                    </div>
                </div>
            `;
            // Add event listeners after the elements are in the DOM
            setTimeout(() => {
                const macroGoalsForm = document.getElementById('macroGoalsForm');
                if (macroGoalsForm) macroGoalsForm.addEventListener('submit', handleUpdateMacroGoals);
                const addMealForm = document.getElementById('addMealForm');
                if (addMealForm) addMealForm.addEventListener('submit', handleAddMeal);
                const mealsList = document.getElementById('mealsList');
                meals.forEach(meal => {
                    const li = document.createElement('li');
                    li.className = "flex justify-between items-center bg-slate-100 p-2 rounded-md";
                    li.innerHTML = `<span>${meal.name}</span><span class="text-xs text-gray-500">P:${meal.protein} C:${meal.carbs} F:${meal.fat}</span>`;
                    mealsList.appendChild(li);
                });
            }, 0);
            
            return content;
        }

        function renderWeights() {
            const content = document.createElement('div');
            content.className = "space-y-6 text-gray-800 max-w-2xl mx-auto";
            const messageEl = message ? `<div class="p-3 bg-blue-100 text-blue-800 rounded-lg text-sm text-center card">${message}</div>` : '';
            content.innerHTML = `
                <h2 class="text-2xl font-bold text-center text-indigo-600">Weight Tracker</h2>
                ${messageEl}
                <div class="rounded-xl shadow-md p-4 card">
                    <h3 class="text-lg font-semibold mb-2">Log New Weight</h3>
                    <form id="addWeightForm" class="flex flex-col space-y-2">
                        <input name="weight" type="number" placeholder="Enter weight in lbs" class="w-full border border-gray-300 rounded-md p-2 bg-slate-100 text-gray-800" />
                        <button type="submit" class="w-full bg-indigo-600 text-white rounded-md py-2 hover:bg-indigo-700 transition duration-300">Add Weight</button>
                    </form>
                </div>
                <div class="rounded-xl shadow-md p-4 card">
                    <h3 class="text-lg font-semibold mb-2">Weight History</h3>
                    <ul id="weightList" class="space-y-1"></ul>
                </div>
            `;
            setTimeout(() => {
                const addWeightForm = document.getElementById('addWeightForm');
                if (addWeightForm) addWeightForm.addEventListener('submit', handleAddWeight);
                const weightList = document.getElementById('weightList');
                weightLog.forEach(log => {
                    const li = document.createElement('li');
                    li.className = "flex justify-between p-2 bg-slate-100 rounded-md";
                    li.innerHTML = `<span>${log.date}</span><span class="font-semibold">${log.weight} lbs</span>`;
                    weightList.appendChild(li);
                });
            }, 0);
            return content;
        }

        function renderMeasurements() {
            const content = document.createElement('div');
            content.className = "space-y-6 text-gray-800 max-w-2xl mx-auto";
            const messageEl = message ? `<div class="p-3 bg-blue-100 text-blue-800 rounded-lg text-sm text-center card">${message}</div>` : '';
            content.innerHTML = `
                <h2 class="text-2xl font-bold text-center text-indigo-600">Measurements Tracker</h2>
                ${messageEl}
                <div class="rounded-xl shadow-md p-4 card">
                    <h3 class="text-lg font-semibold mb-2">Log New Measurements</h3>
                    <form id="addMeasurementsForm" class="flex flex-col space-y-2">
                        <input name="chest" type="number" placeholder="Chest (in)" class="w-full border border-gray-300 rounded-md p-2 bg-slate-100 text-gray-800" />
                        <input name="waist" type="number" placeholder="Waist (in)" class="w-full border border-gray-300 rounded-md p-2 bg-slate-100 text-gray-800" />
                        <input name="thigh" type="number" placeholder="Thigh (in)" class="w-full border border-gray-300 rounded-md p-2 bg-slate-100 text-gray-800" />
                        <button type="submit" class="w-full bg-indigo-600 text-white rounded-md py-2 hover:bg-indigo-700 transition duration-300">Add Measurements</button>
                    </form>
                </div>
                <div class="rounded-xl shadow-md p-4 card">
                    <h3 class="text-lg font-semibold mb-2">Measurements History</h3>
                    <ul id="measurementsList" class="space-y-1"></ul>
                </div>
            `;
            setTimeout(() => {
                const addMeasurementsForm = document.getElementById('addMeasurementsForm');
                if (addMeasurementsForm) addMeasurementsForm.addEventListener('submit', handleAddMeasurements);
                const measurementsList = document.getElementById('measurementsList');
                measurementsLog.forEach(log => {
                    const li = document.createElement('li');
                    li.className = "flex justify-between p-2 bg-slate-100 rounded-md text-sm";
                    li.innerHTML = `<span>${log.date}</span><div class="flex space-x-4"><span>C: ${log.chest}"</span><span>W: ${log.waist}"</span><span>T: ${log.thigh}"</span></div>`;
                    measurementsList.appendChild(li);
                });
            }, 0);
            return content;
        }

        // Main rendering function
        function renderApp() {
            root.innerHTML = '';
            
            if (!isAuthReady) {
                // Render loading spinner
                const loadingContainer = document.createElement('div');
                loadingContainer.className = "flex items-center justify-center min-h-screen w-full";
                loadingContainer.innerHTML = `<div class="loading-animation"></div>`;
                root.appendChild(loadingContainer);
                return;
            }

            const appContainer = document.createElement('div');
            appContainer.className = "min-h-screen flex flex-grow";

            const navBar = document.createElement('nav');
            navBar.className = "w-64 bg-slate-800 text-white flex-shrink-0 p-6 flex flex-col";
            navBar.innerHTML = `
                <div class="flex items-center mb-6">
                    <svg class="h-10 w-10 text-indigo-400" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                    </svg>
                    <h1 class="text-2xl font-bold ml-2">FitSync</h1>
                </div>
                <div class="flex flex-col items-center mb-6">
                    <div class="w-20 h-20 rounded-full bg-indigo-500 flex items-center justify-center text-3xl font-bold text-white">JF</div>
                    <h2 class="mt-2 text-lg font-semibold">John Fitz</h2>
                    <p class="text-xs text-slate-400 truncate w-full text-center mt-1">${user?.uid || 'Loading...'}</p>
                </div>
                <ul class="flex-grow space-y-2">
                    <li><button id="btn-dashboard" class="flex items-center w-full p-3 rounded-lg font-semibold transition-colors duration-300 ${view === 'dashboard' ? 'bg-indigo-600 text-white' : 'text-slate-300 hover:bg-slate-700'}">
                        <svg class="h-5 w-5 mr-3" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zM8 9H6V7h2v2zm4-2h-2v2h2V7zm2 2h-2v2h2V9zM8 11h-2v2h2v-2zm4-2h-2v2h2V9zm2 2h-2v2h2v-2z"></path></svg> Dashboard</button></li>
                    <li><button id="btn-macros" class="flex items-center w-full p-3 rounded-lg font-semibold transition-colors duration-300 ${view === 'macros' ? 'bg-indigo-600 text-white' : 'text-slate-300 hover:bg-slate-700'}">
                        <svg class="h-5 w-5 mr-3" fill="currentColor" viewBox="0 0 20 20"><path d="M9 12a1 1 0 100-2 1 1 0 000 2z"></path><path fill-rule="evenodd" d="M11 11a1 1 0 00-1-1H7a1 1 0 00-1 1v3a1 1 0 001 1h3a1 1 0 001-1v-3zM5 4a2 2 0 012-2h6a2 2 0 012 2v2a2 2 0 01-2 2h-6a2 2 0 01-2-2V4z"></path></svg> Macros</button></li>
                    <li><button id="btn-weights" class="flex items-center w-full p-3 rounded-lg font-semibold transition-colors duration-300 ${view === 'weights' ? 'bg-indigo-600 text-white' : 'text-slate-300 hover:bg-slate-700'}">
                        <svg class="h-5 w-5 mr-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 2a8 8 0 100 16 8 8 0 000-16zM5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg> Weights</button></li>
                    <li><button id="btn-measurements" class="flex items-center w-full p-3 rounded-lg font-semibold transition-colors duration-300 ${view === 'measurements' ? 'bg-indigo-600 text-white' : 'text-slate-300 hover:bg-slate-700'}">
                        <svg class="h-5 w-5 mr-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM8 7a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg> Measurements</button></li>
                </ul>
            `;

            const mainContent = document.createElement('main');
            mainContent.className = "flex-1 overflow-auto p-8";

            appContainer.appendChild(navBar);
            appContainer.appendChild(mainContent);
            root.appendChild(appContainer);

            // Add event listeners to the new navigation buttons
            document.getElementById('btn-dashboard').addEventListener('click', () => { view = 'dashboard'; renderApp(); });
            document.getElementById('btn-macros').addEventListener('click', () => { view = 'macros'; renderApp(); });
            document.getElementById('btn-weights').addEventListener('click', () => { view = 'weights'; renderApp(); });
            document.getElementById('btn-measurements').addEventListener('click', () => { view = 'measurements'; renderApp(); });
            
            // Clear and render the appropriate content
            mainContent.innerHTML = '';
            switch (view) {
                case 'dashboard': mainContent.appendChild(renderDashboard()); break;
                case 'macros': mainContent.appendChild(renderMacros()); break;
                case 'weights': mainContent.appendChild(renderWeights()); break;
                case 'measurements': mainContent.appendChild(renderMeasurements()); break;
            }
        }

        // --- Main Execution Logic ---
        // Initial render of the loading state
        renderApp();
        
        onAuthStateChanged(auth, async (currentUser) => {
            if (currentUser) {
                user = currentUser;
            } else {
                try {
                    await signInAnonymously(auth);
                    user = auth.currentUser;
                } catch (error) {
                    console.error("Authentication error:", error);
                }
            }
            
            if (user) {
                isAuthReady = true;
                renderApp(); // Initial render after auth
                
                const userId = user.uid;

                // Set up real-time listeners for all data
                const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}`);
                onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists() && docSnap.data().macroGoals) {
                        macroGoals = docSnap.data().macroGoals;
                        renderApp();
                    }
                }, (error) => { console.error("Error fetching macro goals:", error); });

                const mealsColRef = collection(db, `/artifacts/${appId}/users/${userId}/meals`);
                onSnapshot(mealsColRef, (snapshot) => {
                    const newMeals = [];
                    let totalProtein = 0;
                    let totalCarbs = 0;
                    let totalFat = 0;
                    snapshot.forEach(doc => {
                        const meal = doc.data();
                        newMeals.push({ id: doc.id, ...meal });
                        totalProtein += meal.protein;
                        totalCarbs += meal.carbs;
                        totalFat += meal.fat;
                    });
                    newMeals.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                    meals = newMeals;
                    dailyMacros = { protein: totalProtein, carbs: totalCarbs, fat: totalFat };
                    renderApp();
                }, (error) => { console.error("Error fetching meals:", error); });

                const weightsColRef = collection(db, `/artifacts/${appId}/users/${userId}/weights`);
                onSnapshot(weightsColRef, (snapshot) => {
                    const newWeights = [];
                    snapshot.forEach(doc => newWeights.push({ id: doc.id, ...doc.data() }));
                    newWeights.sort((a, b) => new Date(a.date) - new Date(b.date));
                    weightLog = newWeights;
                    renderApp();
                }, (error) => { console.error("Error fetching weights:", error); });
                
                const measurementsColRef = collection(db, `/artifacts/${appId}/users/${userId}/measurements`);
                onSnapshot(measurementsColRef, (snapshot) => {
                    const newMeasurements = [];
                    snapshot.forEach(doc => newMeasurements.push({ id: doc.id, ...doc.data() }));
                    newMeasurements.sort((a, b) => new Date(a.date) - new Date(b.date));
                    measurementsLog = newMeasurements;
                    renderApp();
                }, (error) => { console.error("Error fetching measurements:", error); });
            }
        });
    </script>
</body>
</html>
