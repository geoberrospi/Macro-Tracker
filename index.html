<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Fitness Tracker</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d10; /* Very dark background */
        }
        .loading-animation {
            border: 4px solid #3f3f46;
            border-top: 4px solid #8b5cf6; /* Purple accent */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .card {
            border: 1px solid #27272a;
            background-color: #18181b;
        }
        .icon-small {
            width: 1.25rem;
            height: 1.25rem;
        }
    </style>
</head>
<body class="bg-gray-950 text-gray-200">
    <div id="root" class="min-h-screen flex flex-col items-center justify-center p-4">
        <!-- Loading state initially -->
        <div id="loading" class="flex flex-col items-center text-purple-300">
            <div class="loading-animation mb-4"></div>
            <p>Loading your data...</p>
        </div>
    </div>

    <script type="module">
        // Import necessary Firebase libraries
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, addDoc, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- YOUR ACTUAL FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBaSQUmyDz0XN2c1rlLRN_KwnCQ4HMJgqg",
            authDomain: "countdown-gains.firebaseapp.com",
            projectId: "countdown-gains",
            storageBucket: "countdown-gains.firebasestorage.app",
            messagingSenderId: "394980236780",
            appId: "1:394980236780:web:d4e25fb0febd6a5f3374c9"
        };
        const appId = firebaseConfig.appId;

        // Global state variables
        let user = null;
        let view = 'dashboard';
        let macroGoals = { protein: 137, carbs: 307, fat: 106 };
        let dailyMacros = { protein: 0, carbs: 0, fat: 0 };
        let meals = [];
        let weightLog = [];
        let measurementsLog = [];
        let message = '';
        const root = document.getElementById('root');
        let unsubscribeListeners = [];

        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let dataLoaded = {
            macroGoals: false,
            meals: false,
            weights: false,
            measurements: false
        };

        function showMessage(msg) {
            message = msg;
            renderApp();
            setTimeout(() => {
                message = '';
                renderApp();
            }, 3000);
        }

        function calculateCountdown(targetDate) {
            const now = new Date();
            const target = new Date(targetDate);
            const diff = target - now;
            if (diff <= 0) return { days: 0, hours: 0, minutes: 0, seconds: 0 };
            const seconds = Math.floor((diff / 1000) % 60);
            const minutes = Math.floor((diff / 1000 / 60) % 60);
            const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            return { days, hours, minutes, seconds };
        }

        function setupDataListeners(userId) {
            unsubscribeListeners.forEach(unsubscribe => unsubscribe());
            unsubscribeListeners = [];

            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}`);
            unsubscribeListeners.push(onSnapshot(userDocRef, (doc) => {
                if (doc.exists() && doc.data().macroGoals) {
                    macroGoals = doc.data().macroGoals;
                }
                dataLoaded.macroGoals = true;
                checkAllDataLoaded();
            }));

            const mealsColRef = query(collection(db, `artifacts/${appId}/users/${userId}/meals`));
            unsubscribeListeners.push(onSnapshot(mealsColRef, (snapshot) => {
                meals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                const today = new Date().toISOString().split('T')[0];
                dailyMacros.protein = meals.filter(m => m.timestamp && m.timestamp.toDate().toISOString().split('T')[0] === today).reduce((sum, m) => sum + m.protein, 0);
                dailyMacros.carbs = meals.filter(m => m.timestamp && m.timestamp.toDate().toISOString().split('T')[0] === today).reduce((sum, m) => sum + m.carbs, 0);
                dailyMacros.fat = meals.filter(m => m.timestamp && m.timestamp.toDate().toISOString().split('T')[0] === today).reduce((sum, m) => sum + m.fat, 0);
                dataLoaded.meals = true;
                checkAllDataLoaded();
            }));

            const weightsColRef = query(collection(db, `artifacts/${appId}/users/${userId}/weights`));
            unsubscribeListeners.push(onSnapshot(weightsColRef, (snapshot) => {
                weightLog = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => new Date(a.date) - new Date(b.date));
                dataLoaded.weights = true;
                checkAllDataLoaded();
            }));

            const measurementsColRef = query(collection(db, `artifacts/${appId}/users/${userId}/measurements`));
            unsubscribeListeners.push(onSnapshot(measurementsColRef, (snapshot) => {
                measurementsLog = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => new Date(a.date) - new Date(b.date));
                dataLoaded.measurements = true;
                checkAllDataLoaded();
            }));
        }

        function checkAllDataLoaded() {
            if (Object.values(dataLoaded).every(status => status)) {
                renderApp();
            }
        }

        onAuthStateChanged(auth, (authUser) => {
            if (authUser) {
                user = authUser;
                setupDataListeners(user.uid);
            } else {
                user = null;
                signInAnonymously(auth).catch((error) => {
                    console.error("Anonymous sign-in failed:", error);
                    showMessage("Authentication failed. Please try again later.");
                });
            }
        });

        async function handleUpdateMacroGoals(e) {
            e.preventDefault();
            const form = e.target;
            const newProtein = Number(form.protein.value);
            const newCarbs = Number(form.carbs.value);
            const newFat = Number(form.fat.value);

            if (!user) {
                showMessage('Authentication not complete. Please wait.');
                return;
            }
            
            try {
                const userDocRef = doc(db, `artifacts/${appId}/users/${user.uid}`);
                await setDoc(userDocRef, { macroGoals: { protein: newProtein, carbs: newCarbs, fat: newFat } }, { merge: true });
                showMessage('Macro goals updated successfully!');
            } catch (e) {
                console.error("Error updating macro goals: ", e);
                showMessage('Failed to update macro goals.');
            }
        }
        
        async function handleAddMeal(e) {
            e.preventDefault();
            const form = e.target;
            const name = form.mealName.value;
            const protein = Number(form.protein.value);
            const carbs = Number(form.carbs.value);
            const fat = Number(form.fat.value);
        
            if (!name || !protein || !carbs || !fat) {
                showMessage('Please fill out all meal fields.');
                return;
            }
            if (!user) {
                showMessage('Authentication not complete. Please wait.');
                return;
            }
            
            try {
                const mealsColRef = collection(db, `artifacts/${appId}/users/${user.uid}/meals`);
                await addDoc(mealsColRef, { name, protein, carbs, fat, timestamp: serverTimestamp() });
                form.reset();
                showMessage('Meal added successfully!');
            } catch (e) {
                console.error("Error adding meal:", e);
                showMessage('Failed to add meal.');
            }
        }

        async function handleAddWeight(e) {
            e.preventDefault();
            const form = e.target;
            const weight = Number(form.weight.value);
            const date = form.date.value;
            if (!weight || !date) {
                showMessage('Please enter a weight and select a date.');
                return;
            }
            if (!user) {
                showMessage('Authentication not complete. Please wait.');
                return;
            }

            try {
                const weightsColRef = collection(db, `artifacts/${appId}/users/${user.uid}/weights`);
                await addDoc(weightsColRef, { weight, date, timestamp: serverTimestamp() });
                form.reset();
                showMessage('Weight added successfully!');
            } catch (e) {
                console.error("Error adding weight:", e);
                showMessage('Failed to add weight.');
            }
        }

        async function handleAddMeasurements(e) {
            e.preventDefault();
            const form = e.target;
            const date = form.date.value;
            const chest = Number(form.chest.value);
            const waist = Number(form.waist.value);
            const thigh = Number(form.thigh.value);
            if (!chest || !waist || !thigh || !date) {
                showMessage('Please enter all measurements and a date.');
                return;
            }
            if (!user) {
                showMessage('Authentication not complete. Please wait.');
                return;
            }

            try {
                const measurementsColRef = collection(db, `artifacts/${appId}/users/${user.uid}/measurements`);
                await addDoc(measurementsColRef, { chest, waist, thigh, date, timestamp: serverTimestamp() });
                form.reset();
                showMessage('Measurements added successfully!');
            } catch (e) {
                console.error("Error adding measurements:", e);
                showMessage('Failed to add measurements.');
            }
        }

        function createLineChart(canvasId, datasets, labels) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            
            const existingChart = Chart.getChart(ctx);
            if (existingChart) {
                existingChart.destroy();
            }

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets.map(dataset => ({
                        ...dataset,
                        borderColor: dataset.borderColor || '#8b5cf6',
                        backgroundColor: dataset.backgroundColor || 'rgba(139, 92, 246, 0.2)',
                        tension: 0.4,
                        fill: false,
                        pointBackgroundColor: dataset.pointBackgroundColor || '#8b5cf6',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: dataset.pointHoverBorderColor || '#8b5cf6',
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e5e7eb'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: datasets[0].label.split(' ')[0],
                                color: '#e5e7eb'
                            },
                            ticks: {
                                color: '#e5e7eb'
                            },
                            grid: {
                                color: '#3f3f46'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#e5e7eb'
                            },
                            grid: {
                                color: '#3f3f46'
                            }
                        }
                    }
                }
            });
        }

        function renderDashboard() {
            return `
                <div class="space-y-6 max-w-4xl mx-auto">
                    <div class="text-center">
                        <h2 class="text-4xl font-bold text-purple-400">Countdown & Gains</h2>
                        <p class="text-gray-400 mt-1">Your personal dashboard for wedding prep and fitness goals.</p>
                    </div>
                    <div class="flex space-x-4">
                        ${createCountdownElement("2025-12-29T00:00:00", "Time until Wedding")}
                        ${createCountdownElement("2025-10-31T00:00:00", "Time until Josh's Wedding")}
                    </div>
                    <div class="rounded-xl shadow-md p-6 card">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold flex items-center text-purple-300">
                                <i class="fas fa-bullseye mr-2"></i> Daily Macro Goals
                            </h3>
                            <button class="text-gray-400 hover:text-white transition duration-300" onclick="showView('macros')">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="p-4 rounded-xl bg-gray-800 text-center">
                                <i class="fas fa-drumstick-bite text-purple-400 icon-small mb-2"></i>
                                <p class="text-xs text-gray-400">Protein</p>
                                <p class="text-lg font-bold">${macroGoals.protein}g</p>
                            </div>
                            <div class="p-4 rounded-xl bg-gray-800 text-center">
                                <i class="fas fa-bread-slice text-purple-400 icon-small mb-2"></i>
                                <p class="text-xs text-gray-400">Carbs</p>
                                <p class="text-lg font-bold">${macroGoals.carbs}g</p>
                            </div>
                            <div class="p-4 rounded-xl bg-gray-800 text-center">
                                <i class="fas fa-cheese text-purple-400 icon-small mb-2"></i>
                                <p class="text-xs text-gray-400">Fat</p>
                                <p class="text-lg font-bold">${macroGoals.fat}g</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createCountdownElement(targetDate, title) {
            const time = calculateCountdown(targetDate);
            return `
                <div class="flex-1 p-6 rounded-xl shadow-md text-center card">
                    <h3 class="text-xl font-bold mb-2 text-purple-300 flex items-center justify-center">
                        <i class="fas fa-calendar-alt mr-2"></i> ${title}
                    </h3>
                    <div class="flex justify-center space-x-4 text-gray-200">
                        <div class="flex flex-col items-center">
                            <span class="text-4xl font-bold">${time.days}</span>
                            <span class="text-sm text-gray-400">Days</span>
                        </div>
                        <div class="flex flex-col items-center">
                            <span class="text-4xl font-bold">${time.hours}</span>
                            <span class="text-sm text-gray-400">Hours</span>
                        </div>
                        <div class="flex flex-col items-center">
                            <span class="text-4xl font-bold">${time.minutes}</span>
                            <span class="text-sm text-gray-400">Minutes</span>
                        </div>
                        <div class="flex flex-col items-center">
                            <span class="text-4xl font-bold">${time.seconds}</span>
                            <span class="text-sm text-gray-400">Seconds</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMacros() {
            const messageEl = message ? `<div class="p-3 bg-purple-900 text-purple-200 rounded-lg text-sm text-center card">${message}</div>` : '';
            const mealsListHtml = meals.map(meal => `
                <li class="flex justify-between items-center bg-gray-800 p-2 rounded-md">
                    <span>${meal.name}</span><span class="text-xs text-gray-400">P:${meal.protein} C:${meal.carbs} F:${meal.fat}</span>
                </li>
            `).join('');
            
            return `
                <div class="space-y-6 text-gray-200 max-w-4xl mx-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-purple-400">Daily Macro Tracker</h2>
                        <button class="text-gray-400 hover:text-white transition duration-300" onclick="showView('dashboard')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    ${messageEl}
                    <div class="rounded-xl shadow-md p-6 card">
                        <h3 class="text-lg font-semibold flex items-center text-purple-300 mb-4">
                            <i class="fas fa-utensils mr-2"></i> Today's Meal Tracker
                        </h3>
                        <div class="grid grid-cols-3 gap-4 mb-4">
                            <div class="p-4 rounded-xl bg-gray-800">
                                <div class="flex items-center mb-2">
                                    <i class="fas fa-drumstick-bite text-purple-400 mr-2"></i>
                                    <span class="font-semibold">Protein</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2.5">
                                    <div class="bg-purple-500 h-2.5 rounded-full" style="width: ${Math.min(100, (dailyMacros.protein / macroGoals.protein) * 100)}%;"></div>
                                </div>
                                <p class="text-xs text-right mt-1">${dailyMacros.protein} / ${macroGoals.protein}g</p>
                            </div>
                            <div class="p-4 rounded-xl bg-gray-800">
                                <div class="flex items-center mb-2">
                                    <i class="fas fa-bread-slice text-purple-400 mr-2"></i>
                                    <span class="font-semibold">Carbs</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2.5">
                                    <div class="bg-purple-500 h-2.5 rounded-full" style="width: ${Math.min(100, (dailyMacros.carbs / macroGoals.carbs) * 100)}%;"></div>
                                </div>
                                <p class="text-xs text-right mt-1">${dailyMacros.carbs} / ${macroGoals.carbs}g</p>
                            </div>
                            <div class="p-4 rounded-xl bg-gray-800">
                                <div class="flex items-center mb-2">
                                    <i class="fas fa-cheese text-purple-400 mr-2"></i>
                                    <span class="font-semibold">Fat</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2.5">
                                    <div class="bg-purple-500 h-2.5 rounded-full" style="width: ${Math.min(100, (dailyMacros.fat / macroGoals.fat) * 100)}%;"></div>
                                </div>
                                <p class="text-xs text-right mt-1">${dailyMacros.fat} / ${macroGoals.fat}g</p>
                            </div>
                        </div>
                        <div class="rounded-xl p-4 bg-gray-800 mb-4">
                            <h4 class="font-semibold text-gray-300 flex items-center mb-2">
                                <i class="fas fa-plus-circle text-purple-400 mr-2"></i> Add a Meal
                            </h4>
                            <form id="addMealForm" class="flex flex-col space-y-2">
                                <input name="mealName" type="text" placeholder="Meal Name (e.g., Chicken Salad)" class="w-full border border-gray-700 bg-gray-900 rounded-md p-2 text-gray-200" />
                                <div class="grid grid-cols-3 gap-2">
                                    <input name="protein" type="number" placeholder="Protein (g)" class="w-full border border-gray-700 bg-gray-900 rounded-md p-2 text-gray-200" />
                                    <input name="carbs" type="number" placeholder="Carbs (g)" class="w-full border border-gray-700 bg-gray-900 rounded-md p-2 text-gray-200" />
                                    <input name="fat" type="number" placeholder="Fat (g)" class="w-full border border-gray-700 bg-gray-900 rounded-md p-2 text-gray-200" />
                                </div>
                                <button type="submit" class="w-full bg-purple-600 text-white rounded-md py-2 hover:bg-purple-700 transition duration-300">Log Meal</button>
                            </form>
                        </div>
                        <div class="rounded-xl p-4 bg-gray-800">
                            <h4 class="font-semibold text-gray-300 flex items-center mb-2">
                                <i class="fas fa-list-alt mr-2"></i> Logged Meals
                            </h4>
                            <ul id="mealsList" class="text-sm mt-2 space-y-1">
                                ${mealsListHtml || '<li class="text-center text-gray-400">No meals logged today.</li>'}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderWeights() {
            const messageEl = message ? `<div class="p-3 bg-purple-900 text-purple-200 rounded-lg text-sm text-center card">${message}</div>` : '';
            const weightLogTableHtml = weightLog.map(log => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${log.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${log.weight}</td>
                </tr>
            `).join('');
            
            return `
                <div class="space-y-6 text-gray-200 max-w-4xl mx-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold flex items-center text-purple-400">
                            <i class="fas fa-weight-hanging mr-2"></i> Weight Tracker
                        </h2>
                        <button class="text-gray-400 hover:text-white transition duration-300" onclick="showView('dashboard')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    ${messageEl}
                    <div class="flex space-x-4">
                        <div class="flex-1 rounded-xl shadow-md p-6 card">
                            <h3 class="text-lg font-semibold flex items-center text-purple-300 mb-4">
                                <i class="fas fa-plus-circle mr-2"></i> Log New Weight
                            </h3>
                            <form id="addWeightForm" class="flex flex-col space-y-2">
                                <input name="date" type="date" class="w-full border border-gray-700 bg-gray-900 rounded-md p-2 text-gray-200" />
                                <div class="flex space-x-2 items-center">
                                    <input name="weight" type="number" step="0.1" placeholder="Weight (lbs)" class="flex-1 border border-gray-700 bg-gray-900 rounded-md p-2 text-gray-200" />
                                    <button type="submit" class="bg-purple-600 text-white rounded-md p-2 hover:bg-purple-700 transition duration-300">
                                        <i class="fas fa-plus"></i> Add
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div class="flex-1 rounded-xl shadow-md p-6 card">
                            <h3 class="text-lg font-semibold flex items-center text-purple-300 mb-4">
                                <i class="fas fa-chart-line mr-2"></i> Progress Chart
                            </h3>
                            <div class="h-64 mb-4">
                                <canvas id="weightChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="rounded-xl shadow-md p-6 card">
                        <h3 class="text-lg font-semibold flex items-center text-purple-300 mb-4">
                            <i class="fas fa-list-alt mr-2"></i> Weight Log
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-700">
                                <thead>
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Weight (lbs)</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-gray-800 divide-y divide-gray-700">
                                    ${weightLogTableHtml || '<tr><td colspan="2" class="px-6 py-4 text-center text-gray-400">No weight logged yet.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMeasurements() {
            const messageEl = message ? `<div class="p-3 bg-purple-900 text-purple-200 rounded-lg text-sm text-center card">${message}</div>` : '';
            const measurementsLogTableHtml = measurementsLog.map(log => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${log.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${log.chest}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${log.waist}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${log.thigh}</td>
                </tr>
            `).join('');

            return `
                <div class="space-y-6 text-gray-200 max-w-4xl mx-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold flex items-center text-purple-400">
                            <i class="fas fa-ruler-horizontal mr-2"></i> Measurements Tracker
                        </h2>
                        <button class="text-gray-400 hover:text-white transition duration-300" onclick="showView('dashboard')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    ${messageEl}
                    <div class="flex space-x-4">
                        <div class="flex-1 rounded-xl shadow-md p-6 card">
                            <h3 class="text-lg font-semibold flex items-center text-purple-300 mb-4">
                                <i class="fas fa-plus-circle mr-2"></i> Log New Measurements
                            </h3>
                            <form id="addMeasurementsForm" class="flex flex-col space-y-2">
                                <input name="date" type="date" class="w-full border border-gray-700 bg-gray-900 rounded-md p-2 text-gray-200" />
                                <div class="flex flex-col space-y-2">
                                    <input name="chest" type="number" step="0.1" placeholder="Chest (in)" class="w-full border border-gray-700 bg-gray-900 rounded-md p-2 text-gray-200" />
                                    <input name="waist" type="number" step="0.1" placeholder="Waist (in)" class="w-full border border-gray-700 bg-gray-900 rounded-md p-2 text-gray-200" />
                                    <input name="thigh" type="number" step="0.1" placeholder="Thigh (in)" class="w-full border border-gray-700 bg-gray-900 rounded-md p-2 text-gray-200" />
                                </div>
                                <button type="submit" class="w-full bg-purple-600 text-white rounded-md py-2 hover:bg-purple-700 transition duration-300">Add Measurement</button>
                            </form>
                        </div>
                        <div class="flex-1 rounded-xl shadow-md p-6 card">
                            <h3 class="text-lg font-semibold flex items-center text-purple-300 mb-4">
                                <i class="fas fa-chart-line mr-2"></i> Progress Chart
                            </h3>
                            <div class="h-64 mb-4">
                                <canvas id="measurementsChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="rounded-xl shadow-md p-6 card">
                        <h3 class="text-lg font-semibold flex items-center text-purple-300 mb-4">
                            <i class="fas fa-list-alt mr-2"></i> Measurement Log
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-700">
                                <thead>
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Chest (in)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Waist (in)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Thigh (in)</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-gray-800 divide-y divide-gray-700">
                                    ${measurementsLogTableHtml || '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-400">No measurements logged yet.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function createNavigation() {
            return `
                <div class="bg-gray-900 border-r border-gray-800 p-4 w-64 flex flex-col items-center">
                    <img src="https://www.gstatic.com/images/branding/product/2x/firebase_lockup_48dp.png" alt="Firebase Logo" class="w-24 mb-6">
                    <nav class="flex-1 w-full space-y-2">
                        <button onclick="showView('dashboard')" class="flex items-center w-full px-4 py-2 rounded-md text-gray-300 hover:bg-gray-800 transition duration-300 ${view === 'dashboard' ? 'bg-purple-600 text-white' : ''}">
                            <i class="fas fa-home mr-3"></i> Dashboard
                        </button>
                        <button onclick="showView('macros')" class="flex items-center w-full px-4 py-2 rounded-md text-gray-300 hover:bg-gray-800 transition duration-300 ${view === 'macros' ? 'bg-purple-600 text-white' : ''}">
                            <i class="fas fa-utensils mr-3"></i> Macros
                        </button>
                        <button onclick="showView('weights')" class="flex items-center w-full px-4 py-2 rounded-md text-gray-300 hover:bg-gray-800 transition duration-300 ${view === 'weights' ? 'bg-purple-600 text-white' : ''}">
                            <i class="fas fa-weight-hanging mr-3"></i> Weights
                        </button>
                        <button onclick="showView('measurements')" class="flex items-center w-full px-4 py-2 rounded-md text-gray-300 hover:bg-gray-800 transition duration-300 ${view === 'measurements' ? 'bg-purple-600 text-white' : ''}">
                            <i class="fas fa-ruler-horizontal mr-3"></i> Measurements
                        </button>
                    </nav>
                </div>
            `;
        }

        function renderApp() {
            if (!user || !Object.values(dataLoaded).every(status => status)) {
                root.innerHTML = `
                    <div id="loading" class="flex flex-col items-center text-purple-300">
                        <div class="loading-animation mb-4"></div>
                        <p>Loading your data...</p>
                    </div>
                `;
                return;
            }

            let contentHtml;
            switch(view) {
                case 'dashboard':
                    contentHtml = renderDashboard();
                    break;
                case 'macros':
                    contentHtml = renderMacros();
                    break;
                case 'weights':
                    contentHtml = renderWeights();
                    break;
                case 'measurements':
                    contentHtml = renderMeasurements();
                    break;
                default:
                    contentHtml = renderDashboard();
            }

            const navHtml = createNavigation();
            root.innerHTML = navHtml + `
                <main class="flex-1 p-6 overflow-y-auto">
                    ${contentHtml}
                </main>
            `;
            
            // Wait for the next tick to ensure the DOM is updated before binding events and rendering charts
            setTimeout(bindEventsAndRenderCharts, 0);
        }

        function bindEventsAndRenderCharts() {
            if (view === 'macros') {
                const addMealForm = document.getElementById('addMealForm');
                if (addMealForm) addMealForm.addEventListener('submit', handleAddMeal);
            }
            if (view === 'weights') {
                const addWeightForm = document.getElementById('addWeightForm');
                if (addWeightForm) addWeightForm.addEventListener('submit', handleAddWeight);
                
                if (weightLog.length > 1) {
                    const sortedLog = [...weightLog].sort((a, b) => new Date(a.date) - new Date(b.date));
                    const labels = sortedLog.map(log => log.date);
                    const datasets = [{ label: 'Weight (lbs)', data: sortedLog.map(log => log.weight) }];
                    createLineChart('weightChart', datasets, labels);
                } else {
                    const chartContainer = document.getElementById('weightChart')?.parentElement;
                    if (chartContainer) {
                        chartContainer.innerHTML = `<div class="text-center text-gray-400 p-4">Log at least two entries to see a chart.</div>`;
                    }
                }
            }
            if (view === 'measurements') {
                const addMeasurementsForm = document.getElementById('addMeasurementsForm');
                if (addMeasurementsForm) addMeasurementsForm.addEventListener('submit', handleAddMeasurements);

                if (measurementsLog.length > 1) {
                    const sortedLog = [...measurementsLog].sort((a, b) => new Date(a.date) - new Date(b.date));
                    const labels = sortedLog.map(log => log.date);
                    const datasets = [
                        { label: 'Chest (in)', data: sortedLog.map(log => log.chest), borderColor: '#a78bfa', backgroundColor: 'rgba(167, 139, 250, 0.2)', pointBackgroundColor: '#a78bfa', pointHoverBorderColor: '#a78bfa' },
                        { label: 'Waist (in)', data: sortedLog.map(log => log.waist), borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.2)', pointBackgroundColor: '#8b5cf6', pointHoverBorderColor: '#8b5cf6' },
                        { label: 'Thigh (in)', data: sortedLog.map(log => log.thigh), borderColor: '#6d28d9', backgroundColor: 'rgba(109, 40, 217, 0.2)', pointBackgroundColor: '#6d28d9', pointHoverBorderColor: '#6d28d9' }
                    ];
                    createLineChart('measurementsChart', datasets, labels);
                } else {
                    const chartContainer = document.getElementById('measurementsChart')?.parentElement;
                    if (chartContainer) {
                        chartContainer.innerHTML = `<div class="text-center text-gray-400 p-4">Log at least two entries to see a chart.</div>`;
                    }
                }
            }
        }
        
        window.showView = (newView) => {
            view = newView;
            renderApp();
        };
        window.handleUpdateMacroGoals = handleUpdateMacroGoals;
        window.handleAddMeal = handleAddMeal;
        window.handleAddWeight = handleAddWeight;
        window.handleAddMeasurements = handleAddMeasurements;

        renderApp();
    </script>
</body>
</html>
