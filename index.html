<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Macro Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #E0E0E0;
        }
        .container {
            max-width: 1000px;
        }
        .card {
            background-color: #1E1E1E;
            border: 1px solid #333;
        }
        .progress-bar-container {
            background-color: #333;
        }
        /* Custom modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal {
            background-color: #1E1E1E;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
            text-align: center;
            max-width: 400px;
            width: 90%;
            border: 1px solid #333;
        }
        .modal.error {
            border-color: #ff4d4f;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="container mx-auto p-6 space-y-8">
        <!-- Header -->
        <header class="text-center">
            <h1 class="text-4xl font-extrabold text-blue-400">Personal Health Tracker</h1>
            <p class="mt-2 text-lg text-gray-400">Track your macros, weight, and measurements with ease.</p>
        </header>

        <!-- Current User ID Display -->
        <div class="flex justify-center">
            <div id="user-id-display" class="bg-gray-800 text-sm p-2 rounded-md font-mono">
                Loading User ID...
            </div>
        </div>

        <!-- Macro Tracker Section -->
        <div class="card p-6 rounded-lg shadow-lg">
            <h2 class="text-3xl font-bold text-green-400 mb-4">Daily Macro Tracker</h2>
            <div class="space-y-4">
                <!-- Macro Goals and Progress -->
                <div class="flex flex-col md:flex-row md:space-x-4 space-y-4 md:space-y-0">
                    <div class="flex-1">
                        <p class="text-xl font-semibold">Protein: <span id="protein-progress" class="font-normal">0g</span> / <span id="protein-goal">137g</span></p>
                        <div class="progress-bar-container w-full h-4 rounded-full mt-2">
                            <div id="protein-bar" class="bg-green-500 h-full rounded-full transition-all duration-500" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div class="flex-1">
                        <p class="text-xl font-semibold">Carbs: <span id="carbs-progress" class="font-normal">0g</span> / <span id="carbs-goal">307g</span></p>
                        <div class="progress-bar-container w-full h-4 rounded-full mt-2">
                            <div id="carbs-bar" class="bg-yellow-500 h-full rounded-full transition-all duration-500" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div class="flex-1">
                        <p class="text-xl font-semibold">Fat: <span id="fat-progress" class="font-normal">0g</span> / <span id="fat-goal">106g</span></p>
                        <div class="progress-bar-container w-full h-4 rounded-full mt-2">
                            <div id="fat-bar" class="bg-red-500 h-full rounded-full transition-all duration-500" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>

                <!-- Add Meal Form -->
                <div class="mt-6">
                    <h3 class="text-2xl font-semibold mb-2">Add a Meal</h3>
                    <form id="add-meal-form" class="space-y-4">
                        <input type="text" id="meal-name" placeholder="Meal Name" required class="w-full p-3 rounded-md bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <input type="number" id="meal-protein" placeholder="Protein (g)" required class="p-3 rounded-md bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500">
                            <input type="number" id="meal-carbs" placeholder="Carbs (g)" required class="p-3 rounded-md bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                            <input type="number" id="meal-fat" placeholder="Fat (g)" required class="p-3 rounded-md bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                        </div>
                        <button type="submit" class="w-full p-3 bg-blue-600 rounded-md hover:bg-blue-700 transition-colors duration-200 font-bold">Add Meal</button>
                    </form>
                </div>

                <!-- Affordance Calculator -->
                <div class="mt-6">
                    <h3 class="text-2xl font-semibold mb-2">Can I Afford This Meal?</h3>
                    <form id="affordance-form" class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <input type="number" id="affordance-protein" placeholder="Protein (g)" required class="p-3 rounded-md bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500">
                            <input type="number" id="affordance-carbs" placeholder="Carbs (g)" required class="p-3 rounded-md bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                            <input type="number" id="affordance-fat" placeholder="Fat (g)" required class="p-3 rounded-md bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                        </div>
                        <button type="submit" class="w-full p-3 bg-indigo-600 rounded-md hover:bg-indigo-700 transition-colors duration-200 font-bold">Check</button>
                    </form>
                    <div id="affordance-result" class="mt-4 p-4 rounded-md text-center hidden"></div>
                </div>

                <!-- Update Macro Goals Form -->
                <div class="mt-6">
                    <h3 class="text-2xl font-semibold mb-2">Update Macro Goals</h3>
                    <form id="update-goals-form" class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <input type="number" id="new-protein-goal" placeholder="New Protein Goal (g)" required class="p-3 rounded-md bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500">
                            <input type="number" id="new-carbs-goal" placeholder="New Carbs Goal (g)" required class="p-3 rounded-md bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                            <input type="number" id="new-fat-goal" placeholder="New Fat Goal (g)" required class="p-3 rounded-md bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                        </div>
                        <button type="submit" class="w-full p-3 bg-purple-600 rounded-md hover:bg-purple-700 transition-colors duration-200 font-bold">Update Goals</button>
                    </form>
                </div>

                <div id="macro-message" class="mt-4 p-4 rounded-md text-center hidden"></div>
            </div>
        </div>

        <!-- Weight Tracker Section -->
        <div class="card p-6 rounded-lg shadow-lg">
            <h2 class="text-3xl font-bold text-red-400 mb-4">Weight Tracker</h2>
            <form id="add-weight-form" class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mb-6">
                <input type="number" id="weight-input" placeholder="Weight (lbs)" required class="flex-1 p-3 rounded-md bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                <input type="date" id="weight-date" required class="flex-1 p-3 rounded-md bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                <button type="submit" class="p-3 bg-red-600 rounded-md hover:bg-red-700 transition-colors duration-200 font-bold">Add Weight</button>
            </form>
            <div class="relative h-96">
                <canvas id="weight-chart"></canvas>
            </div>
        </div>

        <!-- Measurement Tracker Section -->
        <div class="card p-6 rounded-lg shadow-lg">
            <h2 class="text-3xl font-bold text-yellow-400 mb-4">Measurement Tracker</h2>
            <form id="add-measurement-form" class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mb-6">
                <input type="number" id="chest-input" placeholder="Chest (in)" required class="flex-1 p-3 rounded-md bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                <input type="number" id="waist-input" placeholder="Waist (in)" required class="flex-1 p-3 rounded-md bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                <input type="number" id="thigh-input" placeholder="Thigh (in)" required class="flex-1 p-3 rounded-md bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                <input type="date" id="measurement-date" required class="flex-1 p-3 rounded-md bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                <button type="submit" class="p-3 bg-yellow-600 rounded-md hover:bg-yellow-700 transition-colors duration-200 font-bold">Add Measurement</button>
            </form>
            <div class="relative h-96">
                <canvas id="measurements-chart"></canvas>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Initialization and Authentication
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let isAuthReady = false;

        // Custom modal function to replace alert()
        function showModal(message, type = 'info') {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'modal-overlay';
            modalOverlay.innerHTML = `
                <div class="modal ${type === 'error' ? 'error' : ''}">
                    <p>${message}</p>
                    <button class="mt-4 p-2 bg-blue-600 rounded-md hover:bg-blue-700 transition-colors duration-200 font-bold" onclick="this.parentElement.parentElement.remove()">OK</button>
                </div>
            `;
            document.body.appendChild(modalOverlay);
        }

        // Sign in anonymously or with custom token
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                isAuthReady = true;
                document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                console.log("User signed in:", userId);

                // Initial data loading
                setupRealtimeListeners();
            } else {
                try {
                    console.log("Signing in anonymously...");
                    if (initialAuthToken) {
                         await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                    showModal("Authentication failed. Please refresh the page.", 'error');
                }
            }
        });

        // ====================================================================
        // Chart.js Setup
        // ====================================================================

        let weightChart;
        let measurementsChart;

        function createWeightChart(data) {
            const ctx = document.getElementById('weight-chart').getContext('2d');
            const sortedData = data.sort((a, b) => new Date(a.date) - new Date(b.date));
            const labels = sortedData.map(d => d.date);
            const values = sortedData.map(d => d.weight);

            if (weightChart) {
                weightChart.destroy();
            }

            weightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Weight (lbs)',
                        data: values,
                        borderColor: '#f87171',
                        backgroundColor: 'rgba(248, 113, 113, 0.2)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'category',
                            title: { display: true, text: 'Date' },
                            ticks: { color: '#E0E0E0' },
                            grid: { color: '#333' }
                        },
                        y: {
                            title: { display: true, text: 'Weight (lbs)' },
                            ticks: { color: '#E0E0E0' },
                            grid: { color: '#333' }
                        }
                    },
                    plugins: { legend: { labels: { color: '#E0E0E0' } } }
                }
            });
        }

        function createMeasurementsChart(data) {
            const ctx = document.getElementById('measurements-chart').getContext('2d');
            const sortedData = data.sort((a, b) => new Date(a.date) - new Date(b.date));
            const labels = sortedData.map(d => d.date);
            const chestValues = sortedData.map(d => d.chest);
            const waistValues = sortedData.map(d => d.waist);
            const thighValues = sortedData.map(d => d.thigh);

            if (measurementsChart) {
                measurementsChart.destroy();
            }

            measurementsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Chest',
                            data: chestValues,
                            borderColor: '#38b2ac',
                            backgroundColor: 'rgba(56, 178, 172, 0.2)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Waist',
                            data: waistValues,
                            borderColor: '#ecc94b',
                            backgroundColor: 'rgba(236, 201, 75, 0.2)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Thigh',
                            data: thighValues,
                            borderColor: '#ed8936',
                            backgroundColor: 'rgba(237, 137, 54, 0.2)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'category',
                            title: { display: true, text: 'Date' },
                            ticks: { color: '#E0E0E0' },
                            grid: { color: '#333' }
                        },
                        y: {
                            title: { display: true, text: 'Measurement (in)' },
                            ticks: { color: '#E0E0E0' },
                            grid: { color: '#333' }
                        }
                    },
                    plugins: { legend: { labels: { color: '#E0E0E0' } } }
                }
            });
        }

        // ====================================================================
        // Firestore Real-time Listeners
        // ====================================================================

        function setupRealtimeListeners() {
            if (!isAuthReady || !userId) {
                console.error("Auth not ready or userId is missing.");
                return;
            }

            // Macro Goals Listener
            const goalsDocRef = doc(db, 'artifacts', appId, 'users', userId, 'goals', 'macro-goals');
            onSnapshot(goalsDocRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    document.getElementById('protein-goal').textContent = `${data.protein}g`;
                    document.getElementById('carbs-goal').textContent = `${data.carbs}g`;
                    document.getElementById('fat-goal').textContent = `${data.fat}g`;
                } else {
                    // Set default goals if they don't exist
                    setDoc(goalsDocRef, { protein: 137, carbs: 307, fat: 106 });
                }
            });

            // Macro Progress Listener
            const mealsColRef = collection(db, 'artifacts', appId, 'users', userId, 'meals');
            onSnapshot(mealsColRef, (snapshot) => {
                let totalProtein = 0;
                let totalCarbs = 0;
                let totalFat = 0;
                const today = new Date().toISOString().split('T')[0];

                snapshot.forEach(doc => {
                    const meal = doc.data();
                    // Ensure timestamp exists and is a Firestore Timestamp
                    if (meal.timestamp && meal.timestamp.toDate) {
                        const mealDate = meal.timestamp.toDate().toISOString().split('T')[0];
                        if (mealDate === today) {
                            totalProtein += parseInt(meal.protein);
                            totalCarbs += parseInt(meal.carbs);
                            totalFat += parseInt(meal.fat);
                        }
                    }
                });

                document.getElementById('protein-progress').textContent = `${totalProtein}g`;
                document.getElementById('carbs-progress').textContent = `${totalCarbs}g`;
                document.getElementById('fat-progress').textContent = `${totalFat}g`;

                const proteinGoal = parseInt(document.getElementById('protein-goal').textContent);
                const carbsGoal = parseInt(document.getElementById('carbs-goal').textContent);
                const fatGoal = parseInt(document.getElementById('fat-goal').textContent);

                document.getElementById('protein-bar').style.width = `${Math.min((totalProtein / proteinGoal) * 100, 100)}%`;
                document.getElementById('carbs-bar').style.width = `${Math.min((totalCarbs / carbsGoal) * 100, 100)}%`;
                document.getElementById('fat-bar').style.width = `${Math.min((totalFat / fatGoal) * 100, 100)}%`;
            });

            // Weight Tracker Listener
            const weightColRef = collection(db, 'artifacts', appId, 'users', userId, 'weight');
            onSnapshot(weightColRef, (snapshot) => {
                const weights = [];
                snapshot.forEach(doc => {
                    weights.push(doc.data());
                });
                createWeightChart(weights);
            });

            // Measurement Tracker Listener
            const measurementColRef = collection(db, 'artifacts', appId, 'users', userId, 'measurements');
            onSnapshot(measurementColRef, (snapshot) => {
                const measurements = [];
                snapshot.forEach(doc => {
                    measurements.push(doc.data());
                });
                createMeasurementsChart(measurements);
            });
        }


        // ====================================================================
        // Form Handling
        // ====================================================================

        // Add Meal Form
        document.getElementById('add-meal-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady || !userId) {
                showModal("Please wait for authentication to complete.", 'info');
                return;
            }

            const mealName = document.getElementById('meal-name').value;
            const protein = document.getElementById('meal-protein').value;
            const carbs = document.getElementById('meal-carbs').value;
            const fat = document.getElementById('meal-fat').value;

            try {
                const mealsColRef = collection(db, 'artifacts', appId, 'users', userId, 'meals');
                await addDoc(mealsColRef, {
                    mealName,
                    protein,
                    carbs,
                    fat,
                    timestamp: serverTimestamp()
                });
                e.target.reset();
                showModal("Meal added successfully!");
            } catch (error) {
                console.error("Error adding meal:", error);
                showModal("Failed to add meal. Please try again.", 'error');
            }
        });

        // Affordance Calculator
        document.getElementById('affordance-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const affordanceProtein = parseInt(document.getElementById('affordance-protein').value);
            const affordanceCarbs = parseInt(document.getElementById('affordance-carbs').value);
            const affordanceFat = parseInt(document.getElementById('affordance-fat').value);

            const proteinProgress = parseInt(document.getElementById('protein-progress').textContent);
            const carbsProgress = parseInt(document.getElementById('carbs-progress').textContent);
            const fatProgress = parseInt(document.getElementById('fat-progress').textContent);

            const proteinGoal = parseInt(document.getElementById('protein-goal').textContent);
            const carbsGoal = parseInt(document.getElementById('carbs-goal').textContent);
            const fatGoal = parseInt(document.getElementById('fat-goal').textContent);

            const canAfford = (proteinProgress + affordanceProtein <= proteinGoal) &&
                              (carbsProgress + affordanceCarbs <= carbsGoal) &&
                              (fatProgress + affordanceFat <= fatGoal);

            const resultDiv = document.getElementById('affordance-result');
            resultDiv.classList.remove('hidden');

            if (canAfford) {
                resultDiv.textContent = "Yes, you can afford this meal!";
                resultDiv.classList.remove('bg-red-800');
                resultDiv.classList.add('bg-green-800');
            } else {
                resultDiv.textContent = "No, this meal exceeds your daily limits.";
                resultDiv.classList.remove('bg-green-800');
                resultDiv.classList.add('bg-red-800');
            }
        });

        // Update Macro Goals
        document.getElementById('update-goals-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady || !userId) {
                showModal("Please wait for authentication to complete.", 'info');
                return;
            }

            const newProtein = document.getElementById('new-protein-goal').value;
            const newCarbs = document.getElementById('new-carbs-goal').value;
            const newFat = document.getElementById('new-fat-goal').value;

            try {
                const goalsDocRef = doc(db, 'artifacts', appId, 'users', userId, 'goals', 'macro-goals');
                await setDoc(goalsDocRef, {
                    protein: parseInt(newProtein),
                    carbs: parseInt(newCarbs),
                    fat: parseInt(newFat)
                });
                e.target.reset();
                showModal("Macro goals updated successfully!");
            } catch (error) {
                console.error("Error updating goals:", error);
                showModal("Failed to update goals. Please try again.", 'error');
            }
        });

        // Add Weight Form
        document.getElementById('add-weight-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady || !userId) {
                showModal("Please wait for authentication to complete.", 'info');
                return;
            }

            const weight = parseFloat(document.getElementById('weight-input').value);
            const date = document.getElementById('weight-date').value;

            // Check if weight is a valid number
            if (isNaN(weight)) {
                showModal("Please enter a valid number for weight.", 'error');
                return;
            }

            try {
                const weightColRef = collection(db, 'artifacts', appId, 'users', userId, 'weight');
                await addDoc(weightColRef, {
                    weight,
                    date
                });
                e.target.reset();
                showModal("Weight added successfully!");
            } catch (error) {
                console.error("Error adding weight:", error);
                showModal("Failed to add weight. Please try again.", 'error');
            }
        });

        // Add Measurement Form
        document.getElementById('add-measurement-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady || !userId) {
                showModal("Please wait for authentication to complete.", 'info');
                return;
            }

            const chest = parseFloat(document.getElementById('chest-input').value);
            const waist = parseFloat(document.getElementById('waist-input').value);
            const thigh = parseFloat(document.getElementById('thigh-input').value);
            const date = document.getElementById('measurement-date').value;
            
            // Check if measurements are valid numbers
            if (isNaN(chest) || isNaN(waist) || isNaN(thigh)) {
                showModal("Please enter valid numbers for all measurements.", 'error');
                return;
            }

            try {
                const measurementColRef = collection(db, 'artifacts', appId, 'users', userId, 'measurements');
                await addDoc(measurementColRef, {
                    chest,
                    waist,
                    thigh,
                    date
                });
                e.target.reset();
                showModal("Measurements added successfully!");
            } catch (error) {
                console.error("Error adding measurements:", error);
                showModal("Failed to add measurements. Please try again.", 'error');
            }
        });
    </script>
</body>
</html>
